<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lobby - Neon Bingo AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/public/styles.css" rel="stylesheet">
</head>
<body class="bg-dark text-light casino-bg">
  <!-- Top status bar -->
  <div class="lobby-topbar d-flex align-items-center justify-content-between px-3 py-2">
    <div class="d-flex align-items-center gap-2">
      <div class="avatar-placeholder rounded-circle"></div>
      <div>
        <div class="small">Player</div>
        <div id="lobbyNickname" class="fw-bold"></div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2 topbar-metrics">
      <div class="metric-pill">
        <span class="label">Lvl</span>
        <span class="value">100</span>
      </div>
      <div class="metric-pill">
        <span class="label">Coins</span>
        <span class="value" id="metricCoins">105,381</span>
      </div>
      <div class="metric-pill">
        <span class="label">Energy</span>
        <span class="value">50</span>
      </div>
    </div>
  </div>

  <!-- Room carousel area -->
  <div class="lobby-main container-fluid py-4">
    <div class="d-flex justify-content-center mb-3">
      <h2 class="lobby-title">Choose Your Bingo World</h2>
    </div>
    <div class="room-rail-wrapper d-flex align-items-center justify-content-center">
      <button class="rail-arrow btn btn-link text-light" id="roomsPrev">&#9664;</button>
      <div class="room-rail" id="roomList"></div>
      <button class="rail-arrow btn btn-link text-light" id="roomsNext">&#9654;</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/public/js/rooms.js"></script>
  <script src="/public/js/bot.js"></script>
  <script>
    const token = localStorage.getItem('session_token');
    if (!token) {
      window.location.href = '/public/login.html';
    }

    async function getPersonalizedRoomOrder() {
      try {
        const userId = localStorage.getItem('user_id');
        if (!userId) return window.BINGO_ROOMS;
        
        const res = await fetch('/api/get_ai_context.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json();
        
        // Sort rooms by: 1) recently played, 2) favorite genre, 3) default order
        const roomHistory = data.room_preferences || [];
        const playedRoomIds = roomHistory.map(r => r.room_id);
        
        const rooms = [...window.BINGO_ROOMS];
        rooms.sort((a, b) => {
          const aIndex = playedRoomIds.indexOf(a.id);
          const bIndex = playedRoomIds.indexOf(b.id);
          
          // Recently played rooms first
          if (aIndex !== -1 && bIndex === -1) return -1;
          if (aIndex === -1 && bIndex !== -1) return 1;
          if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
          
          return 0; // Keep original order for unplayed rooms
        });
        
        return rooms;
      } catch (e) {
        return window.BINGO_ROOMS;
      }
    }

    async function renderRooms() {
      const list = document.getElementById('roomList');
      list.innerHTML = '';
      
      const rooms = await getPersonalizedRoomOrder();
      
      rooms.forEach(room => {
        const card = document.createElement('div');
        card.className = `room-card-large ${room.backgroundClass || ''}`;
        card.innerHTML = `
          <div class="room-label-strip">${room.difficulty?.toUpperCase() || ''} â€¢ ${room.genre?.toUpperCase() || ''}</div>
          <div class="room-card-inner">
            <h3 class="room-name">${room.name}</h3>
            <p class="room-desc">${room.description}</p>
            <button class="btn btn-light btn-sm mt-2" data-room-id="${room.id}">Play</button>
          </div>`;
        list.appendChild(card);
      });

      list.querySelectorAll('button[data-room-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const code = btn.getAttribute('data-room-id');
          const url = '/public/room.html?room=' + encodeURIComponent(code);
          window.location.href = url;
        });
      });
    }

    function attachRailControls() {
      const rail = document.getElementById('roomList');
      document.getElementById('roomsPrev').addEventListener('click', () => {
        rail.scrollBy({ left: -260, behavior: 'smooth' });
      });
      document.getElementById('roomsNext').addEventListener('click', () => {
        rail.scrollBy({ left: 260, behavior: 'smooth' });
      });
    }

    async function showAIGreeting() {
      try {
        const userId = localStorage.getItem('user_id');
        if (!userId) return;
        
        const res = await fetch('/api/lobby_greeting.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json();
        
        if (data.success && data.greeting) {
          let message = data.greeting;
          
          // Add recommendation to the message if available
          if (data.recommendation && data.recommendation.room_id) {
            const room = window.BINGO_ROOMS.find(r => r.id === data.recommendation.room_id);
            if (room) {
              message += ` Try ${room.name}! ${data.recommendation.reason || ''}`;
            }
          }
          
          // Use the bot interface to show greeting
          if (window.AICoach && typeof window.AICoach.setMessage === 'function') {
            setTimeout(() => {
              window.AICoach.setMessage(message);
            }, 500);
          }
        }
      } catch (e) {
        console.log('AI greeting unavailable');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('lobbyNickname').innerText = localStorage.getItem('nickname') || 'Guest';
      renderRooms();
      attachRailControls();
      showAIGreeting();
    });
  </script>
</body>
</html>
